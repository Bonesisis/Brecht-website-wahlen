<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test-Abstimmung</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <a href="./index.html" class="brand">
        <div class="brand__badge">BW</div>
        <div class="brand__text">
          <div class="brand__title">Brechtwahl</div>
          <div class="brand__subtitle">Test-Abstimmung</div>
        </div>
      </a>
    </header>

    <main class="card card--highlight">
      <h2>Test-Abstimmung</h2>
      <p class="mb-2">Wähle eine Option und sende deine Stimme (Test, keine Authentifizierung).</p>

      <div id="buttons" class="mb-3">
        <button id="btn-yes" class="button">Ja</button>
        <button id="btn-no" class="button button--outline">Nein</button>
      </div>

      <div id="result" class="card card--soft">
        <strong>Ergebnisse:</strong>
        <div id="counts">Lade...</div>
        <div id="winner"></div>
      </div>
    </main>

    <footer class="footer">Nur ein einfacher Test — nicht produktiv.</footer>
  </div>

  <script>
    const API = '/api/test';

    async function fetchCounts() {
      try {
        const res = await fetch(`${API}/votes`);
        const data = await res.json();
        document.getElementById('counts').textContent = `Ja: ${data.yes} · Nein: ${data.no} · Gesamt: ${data.total}`;
        const winner = data.yes > data.no ? 'Ja liegt vorne' : (data.no > data.yes ? 'Nein liegt vorne' : 'Unentschieden');
        document.getElementById('winner').textContent = winner;
      } catch (e) {
        document.getElementById('counts').textContent = 'Fehler beim Laden der Ergebnisse';
      }
    }

    async function sendVote(choice) {
      try {
        const res = await fetch(`${API}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ choice })
        });
        if (!res.ok) throw new Error('Vote failed');
        await fetchCounts();
      } catch (e) {
        alert('Stimme konnte nicht gesendet werden');
      }
    }

    document.getElementById('btn-yes').addEventListener('click', () => sendVote('yes'));
    document.getElementById('btn-no').addEventListener('click', () => sendVote('no'));

    // Polling
    fetchCounts();
    setInterval(fetchCounts, 3000);
  </script>
</body>
</html>
